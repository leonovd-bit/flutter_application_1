<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="FreshPunk Kitchen Dashboard - Manage your orders and restaurant operations.">
  
  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="FreshPunk Kitchen">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>FreshPunk Kitchen Dashboard</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-green: #4CAF50;
      --primary-dark: #388E3C;
      --primary-light: #81C784;
      --background: #FFFFFF;
      --surface: #FFFFFF;
      --surface-elevated: #F8F9FA;
      --text-primary: #212121;
      --text-secondary: #757575;
      --text-light: #BDBDBD;
      --border: #E0E0E0;
      --accent: #4CAF50;
      --success: #4CAF50;
      --warning: #FF9800;
      --error: #F44336;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--background) 0%, rgba(248, 249, 250, 0.95) 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-primary);
      min-height: 100vh;
    }

    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .auth-card {
      text-align: center;
      padding: 48px;
      background: var(--surface);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
      max-width: 480px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .logo {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--primary-green), var(--primary-light));
      border-radius: 24px;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
    }

    h1 {
      margin: 0 0 12px 0;
      color: var(--text-primary);
      font-size: 32px;
      font-weight: 800;
      font-family: 'Poppins', sans-serif;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: var(--text-secondary);
      margin: 0 0 32px 0;
      font-size: 16px;
      font-weight: 500;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }

    input, textarea {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      box-sizing: border-box;
      background: var(--surface);
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, var(--primary-green), var(--primary-light));
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Poppins', sans-serif;
      letter-spacing: 0.3px;
      box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
      margin-bottom: 16px;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
    }

    .button.secondary {
      background: linear-gradient(135deg, #757575, #616161);
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      width: auto;
      box-shadow: 0 2px 8px rgba(117, 117, 117, 0.3);
    }

    .button.small {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      width: auto;
      margin: 4px;
    }

    .error {
      background: #FFEBEE;
      border: 1px solid #FFCDD2;
      color: #C62828;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 600;
      display: none;
    }

    .access-codes {
      background: var(--surface-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-top: 24px;
      text-align: left;
    }

    .access-codes h3 {
      margin: 0 0 16px 0;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
    }

    .access-codes div {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      padding: 8px 12px;
      background: var(--surface);
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    /* Dashboard Styles */
    .dashboard {
      min-height: 100vh;
    }
    
    .dashboard.hidden {
      display: none;
    }

    .dashboard-header {
      background: linear-gradient(135deg, var(--primary-green), var(--primary-light));
      color: white;
      padding: 20px 0;
      box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-title h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 800;
      font-family: 'Poppins', sans-serif;
      letter-spacing: -0.5px;
    }

    .header-title p {
      margin: 4px 0 0 0;
      opacity: 0.9;
      font-size: 16px;
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(224, 224, 224, 0.3);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: var(--surface-elevated);
      padding: 8px;
      border-radius: 12px;
      overflow-x: auto;
    }

    .tab-button {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab-button.active {
      background: var(--primary-green);
      color: white;
    }

    .tab-content {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(224, 224, 224, 0.3);
    }

    .order-card {
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      background: var(--surface);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .order-card.pending {
      border-color: var(--warning);
      background: #FFF8E1;
    }

    .order-card.preparing {
      border-color: #2196F3;
      background: #E3F2FD;
    }

    .order-card.ready {
      border-color: var(--success);
      background: #E8F5E8;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .order-id {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      font-family: 'Poppins', sans-serif;
    }

    .customer-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .order-meta {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .status-badge.pending {
      background: var(--warning);
    }

    .status-badge.preparing {
      background: #2196F3;
    }

    .status-badge.ready {
      background: var(--success);
    }

    .order-total {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
      margin-top: 8px;
    }

    .order-items {
      border-top: 1px solid rgba(224, 224, 224, 0.5);
      padding-top: 16px;
      margin-bottom: 12px;
    }

    .order-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .hidden {
      display: none !important;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      text-align: center;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .order-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .auth-card {
        padding: 32px 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Screen -->
  <div id="auth-screen" class="auth-container">
    <div class="auth-card">
      <div class="logo">
        <svg width="60" height="60" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="15" y="25" width="70" height="50" rx="8" fill="white" opacity="0.9"/>
          <rect x="20" y="30" width="25" height="40" rx="4" fill="currentColor" opacity="0.8"/>
          <circle cx="55" cy="40" rx="8" ry="12" fill="#FF6B35" opacity="0.9"/>
          <rect x="68" y="30" width="12" height="18" rx="2" fill="#4CAF50" opacity="0.8"/>
          <rect x="68" y="52" width="12" height="18" rx="2" fill="#4CAF50" opacity="0.8"/>
          <path d="M10 20 L25 15 L25 80 L10 75 Z" fill="white" opacity="0.9"/>
          <path d="M75 20 L90 15 L90 80 L75 75 Z" fill="white" opacity="0.9"/>
        </svg>
      </div>
      
      <h1>Kitchen Access</h1>
      <p class="subtitle">Choose your authentication method</p>
      
      <div id="error-message" class="error"></div>
      
      <!-- Auth Method Selection -->
      <div id="auth-method-selection">
        <button type="button" class="button" onclick="showAccessCodeAuth()">
          üîë Use Access Code
        </button>
        <button type="button" class="button secondary" onclick="showFirebaseAuth()">
          üîê Firebase Login
        </button>
      </div>

      <!-- Access Code Authentication -->
      <div id="access-code-auth" class="hidden">
        <form id="access-code-form">
          <div class="form-group">
            <label for="access-code">Kitchen Access Code</label>
            <input type="text" id="access-code" required placeholder="Enter your access code" autocomplete="off">
          </div>
          <button type="submit" class="button">Authenticate with Code</button>
          <button type="button" class="button secondary" onclick="showAuthMethodSelection()">‚Üê Back</button>
        </form>
        
        <div class="access-codes">
          <h3>Available Access Codes:</h3>
          <div>KITCHEN001 - Main Kitchen</div>
          <div>KITCHEN002 - East Kitchen</div>
          <div>KITCHEN003 - West Kitchen</div>
        </div>
      </div>

      <!-- Firebase Authentication -->
      <div id="firebase-auth" class="hidden">
        <form id="firebase-auth-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" required autocomplete="email">
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required autocomplete="current-password">
          </div>
          
          <button type="submit" class="button">Sign In with Firebase</button>
          <button type="button" class="button secondary" onclick="showAuthMethodSelection()">‚Üê Back</button>
        </form>
      </div>

      <!-- Registration Screen -->
      <div id="registration-screen" class="hidden">
        <h1>Kitchen Registration</h1>
        <p class="subtitle">Complete your kitchen profile to access the dashboard</p>
        
        <form id="registration-form">
          <div id="registration-error" class="error"></div>
          
          <div class="form-group">
            <label for="kitchen-name">Kitchen Name *</label>
            <input type="text" id="kitchen-name" required>
          </div>
          
          <div class="form-group">
            <label for="kitchen-email">Contact Email *</label>
            <input type="email" id="kitchen-email" required>
          </div>
          
          <div class="form-group">
            <label for="kitchen-phone">Phone Number *</label>
            <input type="tel" id="kitchen-phone" required>
          </div>
          
          <div class="form-group">
            <label for="kitchen-address">Kitchen Address *</label>
            <textarea id="kitchen-address" required rows="3"></textarea>
          </div>
          
          <button type="submit" class="button">Complete Registration</button>
          <button type="button" class="button secondary" onclick="goBackToAuth()">‚Üê Back to Access Code</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loading-screen" class="hidden">
    <div class="auth-container">
      <div class="auth-card">
        <div class="loading">
          <div class="spinner"></div>
          <p>Authenticating...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Kitchen Dashboard -->
  <div id="kitchen-dashboard" class="dashboard hidden">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="header-content">
        <div class="header-title">
          <h1>üçΩÔ∏è FreshPunk Kitchen</h1>
          <p id="kitchen-name-display">Loading...</p>
        </div>
        <div class="header-actions">
          <button class="button secondary" onclick="showAddMealForm()">+ Add Meal</button>
          <button class="button secondary" onclick="refreshDashboard()">üîÑ Refresh</button>
          <button class="button secondary" onclick="signOut()">Logout</button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" style="color: var(--primary-green);" id="active-orders">12</div>
          <div class="stat-label">Active Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" style="color: var(--warning);" id="preparing-orders">7</div>
          <div class="stat-label">Preparing</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" style="color: #2196F3;" id="completed-today">28</div>
          <div class="stat-label">Completed Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" style="color: #9C27B0;" id="available-meals">15</div>
          <div class="stat-label">Available Meals</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-button active" onclick="showTab('orders')" id="tab-orders">üìã Orders</button>
        <button class="tab-button" onclick="showTab('meals')" id="tab-meals">üçΩÔ∏è Meals</button>
        <button class="tab-button" onclick="showTab('analytics')" id="tab-analytics">üìä Analytics</button>
      </div>

      <!-- Tab Content -->
      <div id="tab-content">
        <!-- Orders Tab (Default) -->
        <div id="orders-content" class="tab-content">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
            <h2 style="margin: 0; color: var(--text-primary); font-size: 20px; font-weight: 700; font-family: 'Poppins', sans-serif;">Active Orders</h2>
            
            <!-- Order Filters -->
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="button small active" onclick="filterOrders('all')" id="filter-all">All</button>
              <button class="button small" onclick="filterOrders('pending')" id="filter-pending">Pending</button>
              <button class="button small" onclick="filterOrders('preparing')" id="filter-preparing">Preparing</button>
              <button class="button small" onclick="filterOrders('ready')" id="filter-ready">Ready</button>
            </div>
          </div>
          
          <!-- Orders List -->
          <div id="orders-list">
            <!-- Orders will be loaded here -->
          </div>
        </div>

        <!-- Meals Tab -->
        <div id="meals-content" class="tab-content hidden">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
            <h2 style="margin: 0; color: var(--text-primary); font-size: 20px; font-weight: 700; font-family: 'Poppins', sans-serif;">Menu Management</h2>
            <button class="button" onclick="showAddMealForm()">+ Add New Meal</button>
          </div>
          <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">üçΩÔ∏è</div>
            <p style="font-size: 16px; margin: 0;">Menu management interface coming soon!</p>
            <p style="font-size: 14px; margin: 8px 0 0 0;">Add, edit, and manage your meal offerings here.</p>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-content" class="tab-content hidden">
          <h2 style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 20px; font-weight: 700; font-family: 'Poppins', sans-serif;">Kitchen Analytics</h2>
          <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <p style="font-size: 16px; margin: 0;">Analytics dashboard coming soon!</p>
            <p style="font-size: 14px; margin: 8px 0 0 0;">Track performance, revenue, and customer insights.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  
  <script>
    // Use Firebase v9 compat API for simpler implementation

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCFeughLAfJ3THhLWVnxLqvvf2mjomkGxg",
      authDomain: "freshpunk-48db1.firebaseapp.com",
      projectId: "freshpunk-48db1",
      storageBucket: "freshpunk-48db1.firebasestorage.app",
      messagingSenderId: "433852717304",
      appId: "1:433852717304:web:318fdb802f7ff7f7c0c30d",
      measurementId: "G-11FZ3EQS7Y"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const functions = firebase.functions();

    // Global variables
    let currentUser = null;
    let kitchenData = null;
    let currentAuthMethod = null;

    // Valid access codes
    const validCodes = ['KITCHEN001', 'KITCHEN002', 'KITCHEN003'];

    // DOM elements
    const authScreen = document.getElementById('auth-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const kitchenDashboard = document.getElementById('kitchen-dashboard');
    const errorMessage = document.getElementById('error-message');

    // Show/hide screens
    function showScreen(screenId) {
      console.log('showScreen called with:', screenId);
      
      document.querySelectorAll('.auth-container, .dashboard, #loading-screen').forEach(el => {
        el.classList.add('hidden');
      });
      
      const targetElement = document.getElementById(screenId);
      if (targetElement) {
        targetElement.classList.remove('hidden');
        console.log('Screen', screenId, 'should now be visible');
        
        // Debug: Check if element is actually visible
        const computedStyle = window.getComputedStyle(targetElement);
        console.log('Element display:', computedStyle.display);
        console.log('Element visibility:', computedStyle.visibility);
        console.log('Element opacity:', computedStyle.opacity);
        console.log('Element dimensions:', targetElement.offsetWidth, 'x', targetElement.offsetHeight);
        console.log('Element has hidden class:', targetElement.classList.contains('hidden'));
      } else {
        console.error('Element with ID', screenId, 'not found');
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    // Authentication method selection
    window.showAuthMethodSelection = function() {
      document.getElementById('auth-method-selection').classList.remove('hidden');
      document.getElementById('access-code-auth').classList.add('hidden');
      document.getElementById('firebase-auth').classList.add('hidden');
      document.getElementById('registration-screen').classList.add('hidden');
      hideError();
    };

    window.showAccessCodeAuth = function() {
      document.getElementById('auth-method-selection').classList.add('hidden');
      document.getElementById('access-code-auth').classList.remove('hidden');
      document.getElementById('firebase-auth').classList.add('hidden');
      currentAuthMethod = 'access-code';
      hideError();
    };

    window.showFirebaseAuth = function() {
      document.getElementById('auth-method-selection').classList.add('hidden');
      document.getElementById('access-code-auth').classList.add('hidden');
      document.getElementById('firebase-auth').classList.remove('hidden');
      currentAuthMethod = 'firebase';
      hideError();
    };

    // Access code authentication
    document.getElementById('access-code-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const code = document.getElementById('access-code').value.trim().toUpperCase();
      hideError();

      if (!code) {
        showError('Please enter an access code');
        return;
      }

      if (!validCodes.includes(code)) {
        showError('Invalid access code');
        return;
      }

      showScreen('loading-screen');
      
      // Store access code and check if registered
      sessionStorage.setItem('kitchen_code', code);
      const existingData = sessionStorage.getItem('kitchen_data');
      
      setTimeout(() => {
        if (existingData) {
          kitchenData = JSON.parse(existingData);
          sessionStorage.setItem('kitchen_access', 'true');
          showKitchenDashboard();
        } else {
          showKitchenRegistration();
        }
      }, 1000);
    });

    // Firebase authentication
    document.getElementById('firebase-auth-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      hideError();
      showScreen('loading-screen');

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        const idTokenResult = await user.getIdTokenResult();
        const isKitchen = idTokenResult.claims.kitchen || false;

        if (!isKitchen) {
          throw new Error('Access denied. Kitchen partner role required.');
        }

        currentUser = user;
        kitchenData = {
          name: idTokenResult.claims.kitchenName || 'Firebase Kitchen',
          email: user.email,
          method: 'firebase',
          uid: user.uid
        };

        sessionStorage.setItem('kitchen_access', 'true');
        sessionStorage.setItem('kitchen_data', JSON.stringify(kitchenData));
        showKitchenDashboard();

      } catch (error) {
        console.error('Authentication error:', error);
        showError(error.message || 'Authentication failed. Please check your credentials.');
        showScreen('auth-screen');
      }
    });

    // Kitchen registration
    function showKitchenRegistration() {
      document.getElementById('auth-method-selection').classList.add('hidden');
      document.getElementById('access-code-auth').classList.add('hidden');
      document.getElementById('firebase-auth').classList.add('hidden');
      document.getElementById('registration-screen').classList.remove('hidden');
      showScreen('auth-screen');
    }

    document.getElementById('registration-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const name = document.getElementById('kitchen-name').value.trim();
      const email = document.getElementById('kitchen-email').value.trim();
      const phone = document.getElementById('kitchen-phone').value.trim();
      const address = document.getElementById('kitchen-address').value.trim();
      
      if (!name || !email || !phone || !address) {
        showRegistrationError('Please fill in all required fields');
        return;
      }
      
      kitchenData = {
        name: name,
        email: email,
        phone: phone,
        address: address,
        code: sessionStorage.getItem('kitchen_code'),
        registeredAt: new Date().toISOString(),
        method: 'access-code'
      };
      
      sessionStorage.setItem('kitchen_data', JSON.stringify(kitchenData));
      sessionStorage.setItem('kitchen_access', 'true');
      
      showScreen('loading-screen');
      setTimeout(() => {
        showKitchenDashboard();
      }, 1500);
    });

    function showRegistrationError(message) {
      const errorDiv = document.getElementById('registration-error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    window.goBackToAuth = function() {
      showAuthMethodSelection();
    };

    // Kitchen Dashboard
    function showKitchenDashboard() {
      console.log('showKitchenDashboard called');
      console.log('kitchenData:', kitchenData);
      
      showScreen('kitchen-dashboard');
      
      const nameDisplay = document.getElementById('kitchen-name-display');
      if (nameDisplay && kitchenData) {
        nameDisplay.textContent = kitchenData.name;
        console.log('Kitchen name set to:', kitchenData.name);
      } else {
        console.error('Missing kitchen name display element or kitchenData');
      }
      
      loadOrders();
      console.log('Dashboard should now be visible');
    }

    // Dashboard functions
    window.showTab = function(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');

      // Show content
      document.querySelectorAll('[id$="-content"]').forEach(content => content.classList.add('hidden'));
      document.getElementById(tabName + '-content').classList.remove('hidden');

      if (tabName === 'orders') {
        loadOrders();
      }
    };

    window.filterOrders = function(status) {
      document.querySelectorAll('[id^="filter-"]').forEach(btn => btn.classList.remove('active'));
      document.getElementById('filter-' + status).classList.add('active');
      // Filter logic would go here
    };

    window.updateOrderStatus = function(orderId, newStatus) {
      alert(`Order ${orderId} status updated to: ${newStatus.toUpperCase()}`);
      setTimeout(() => {
        loadOrders();
      }, 500);
    };

    window.viewOrderDetails = function(orderId) {
      alert(`View details for order: ${orderId}`);
    };

    window.showAddMealForm = function() {
      alert('Add meal form coming soon!');
    };

    window.refreshDashboard = function() {
      loadOrders();
      // Update stats
      updateStats();
    };

    window.signOut = function() {
      if (currentUser) {
        auth.signOut();
      }
      sessionStorage.clear();
      currentUser = null;
      kitchenData = null;
      showScreen('auth-screen');
      showAuthMethodSelection();
    };

    // Load orders (sample data)
    function loadOrders() {
      const orders = generateSampleOrders();
      const ordersContainer = document.getElementById('orders-list');
      ordersContainer.innerHTML = orders.map(order => createOrderCard(order)).join('');
    }

    function generateSampleOrders() {
      return [
        {
          id: 'ORD001',
          customer: 'John Smith',
          phone: '+1 (555) 123-4567',
          items: [
            { name: 'Grilled Chicken Salad', quantity: 2, price: 14.99 },
            { name: 'Fresh Fruit Bowl', quantity: 1, price: 8.99 }
          ],
          total: 38.97,
          status: 'pending',
          orderTime: '2:45 PM',
          estimatedReady: '3:15 PM',
          address: '123 Main St, Downtown',
          deliveryMethod: 'Pickup',
          notes: 'Extra dressing on the side'
        },
        {
          id: 'ORD002',
          customer: 'Sarah Johnson',
          phone: '+1 (555) 987-6543',
          items: [
            { name: 'Quinoa Power Bowl', quantity: 1, price: 16.99 },
            { name: 'Green Smoothie', quantity: 2, price: 6.99 }
          ],
          total: 30.97,
          status: 'preparing',
          orderTime: '2:30 PM',
          estimatedReady: '3:00 PM',
          address: '456 Oak Ave, Midtown',
          deliveryMethod: 'Delivery',
          notes: 'No onions please'
        },
        {
          id: 'ORD003',
          customer: 'Mike Wilson',
          phone: '+1 (555) 456-7890',
          items: [
            { name: 'Mediterranean Wrap', quantity: 3, price: 12.99 }
          ],
          total: 38.97,
          status: 'ready',
          orderTime: '2:15 PM',
          estimatedReady: '2:45 PM',
          address: '789 Pine St, Uptown',
          deliveryMethod: 'Pickup',
          notes: 'Call when ready'
        }
      ];
    }

    function createOrderCard(order) {
      return `
        <div class="order-card ${order.status}" onclick="viewOrderDetails('${order.id}')">
          <div class="order-header">
            <div>
              <div class="order-id">${order.id}</div>
              <div class="customer-name">${order.customer}</div>
              <div class="order-meta">üì± ${order.phone}</div>
              <div class="order-meta">üïê Ordered: ${order.orderTime} | Ready: ${order.estimatedReady}</div>
              <div class="order-meta">${order.deliveryMethod === 'Pickup' ? 'üè™' : 'üöö'} ${order.deliveryMethod}</div>
            </div>
            <div style="text-align: right;">
              <div class="status-badge ${order.status}">${order.status.toUpperCase()}</div>
              <div class="order-total">$${order.total.toFixed(2)}</div>
            </div>
          </div>
          
          <div class="order-items">
            <strong>Items:</strong><br>
            ${order.items.map(item => `‚Ä¢ ${item.quantity}x ${item.name} - $${item.price}`).join('<br>')}
            ${order.notes ? `<br><br><strong>Notes:</strong> ${order.notes}` : ''}
          </div>
          
          <div class="order-actions">
            ${order.status === 'pending' ? `<button class="button small" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'preparing')" style="background: var(--warning);">Start Preparing</button>` : ''}
            ${order.status === 'preparing' ? `<button class="button small" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'ready')" style="background: var(--success);">Mark Ready</button>` : ''}
            ${order.status === 'ready' ? `<button class="button small" onclick="event.stopPropagation(); updateOrderStatus('${order.id}', 'completed')" style="background: #2196F3;">Mark Completed</button>` : ''}
            <button class="button small secondary" onclick="event.stopPropagation(); viewOrderDetails('${order.id}')">View Details</button>
          </div>
        </div>
      `;
    }

    function updateStats() {
      // Update dashboard stats with sample data
      document.getElementById('active-orders').textContent = '12';
      document.getElementById('preparing-orders').textContent = '7';
      document.getElementById('completed-today').textContent = '28';
      document.getElementById('available-meals').textContent = '15';
    }

    // Initialize
    updateStats();

    // Listen for authentication state changes
    auth.onAuthStateChanged(async (user) => {
      console.log('Auth state changed. User:', user ? user.email : 'null', 'Method:', currentAuthMethod);
      
      if (user && currentAuthMethod === 'firebase') {
        try {
          const idTokenResult = await user.getIdTokenResult();
          const isKitchen = idTokenResult.claims.kitchen || false;
          console.log('User claims - kitchen:', isKitchen);

          if (isKitchen) {
            currentUser = user;
            kitchenData = {
              name: idTokenResult.claims.kitchenName || 'Firebase Kitchen',
              email: user.email,
              method: 'firebase',
              uid: user.uid
            };
            sessionStorage.setItem('kitchen_data', JSON.stringify(kitchenData));
            console.log('Firebase auth successful, showing dashboard');
            showKitchenDashboard();
          } else {
            await auth.signOut();
            showError('Access denied. Kitchen partner role required.');
            showScreen('auth-screen');
          }
        } catch (error) {
          console.error('Token verification error:', error);
          showScreen('auth-screen');
        }
      } else if (!user && currentAuthMethod === 'firebase') {
        console.log('No user and firebase method, showing auth');
        showScreen('auth-screen');
        showAuthMethodSelection();
      }
    });

    // Check if already authenticated on page load
    const existingAccess = sessionStorage.getItem('kitchen_access');
    const existingData = sessionStorage.getItem('kitchen_data');
    
    console.log('Page load check - existingAccess:', existingAccess, 'existingData:', existingData);
    
    if (existingAccess === 'true' && existingData) {
      kitchenData = JSON.parse(existingData);
      console.log('Restored kitchenData:', kitchenData);
      
      if (kitchenData.method === 'firebase') {
        currentAuthMethod = 'firebase';
        console.log('Firebase method detected, waiting for auth state change');
        // Firebase auth will handle this via onAuthStateChanged
      } else {
        console.log('Non-firebase method, showing dashboard directly');
        showKitchenDashboard();
      }
    } else {
      console.log('No existing authentication, showing auth screen');
      showScreen('auth-screen');
      showAuthMethodSelection();
    }
  </script>
</body>
</html>
